\doxysection{debayer\+\_\+cpu.\+h}
\hypertarget{debayer__cpu_8h_source}{}\label{debayer__cpu_8h_source}\index{src/peripherals/camera/libcamera/src/libcamera/software\_isp/debayer\_cpu.h@{src/peripherals/camera/libcamera/src/libcamera/software\_isp/debayer\_cpu.h}}

\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{comment}{/*\ SPDX-\/License-\/Identifier:\ LGPL-\/2.1-\/or-\/later\ */}}
\DoxyCodeLine{00002\ \textcolor{comment}{/*}}
\DoxyCodeLine{00003\ \textcolor{comment}{\ *\ Copyright\ (C)\ 2023,\ Linaro\ Ltd}}
\DoxyCodeLine{00004\ \textcolor{comment}{\ *\ Copyright\ (C)\ 2023,\ Red\ Hat\ Inc.}}
\DoxyCodeLine{00005\ \textcolor{comment}{\ *}}
\DoxyCodeLine{00006\ \textcolor{comment}{\ *\ Authors:}}
\DoxyCodeLine{00007\ \textcolor{comment}{\ *\ Hans\ de\ Goede\ <hdegoede@redhat.com>}}
\DoxyCodeLine{00008\ \textcolor{comment}{\ *}}
\DoxyCodeLine{00009\ \textcolor{comment}{\ *\ CPU\ based\ debayering\ header}}
\DoxyCodeLine{00010\ \textcolor{comment}{\ */}}
\DoxyCodeLine{00011\ }
\DoxyCodeLine{00012\ \textcolor{preprocessor}{\#pragma\ once}}
\DoxyCodeLine{00013\ }
\DoxyCodeLine{00014\ \textcolor{preprocessor}{\#include\ <memory>}}
\DoxyCodeLine{00015\ \textcolor{preprocessor}{\#include\ <stdint.h>}}
\DoxyCodeLine{00016\ \textcolor{preprocessor}{\#include\ <vector>}}
\DoxyCodeLine{00017\ }
\DoxyCodeLine{00018\ \textcolor{preprocessor}{\#include\ <\mbox{\hyperlink{object_8h}{libcamera/base/object.h}}>}}
\DoxyCodeLine{00019\ }
\DoxyCodeLine{00020\ \textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{bayer__format_8h}{libcamera/internal/bayer\_format.h}}"{}}}
\DoxyCodeLine{00021\ }
\DoxyCodeLine{00022\ \textcolor{preprocessor}{\#include\ "{}debayer.h"{}}}
\DoxyCodeLine{00023\ \textcolor{preprocessor}{\#include\ "{}swstats\_cpu.h"{}}}
\DoxyCodeLine{00024\ }
\DoxyCodeLine{00025\ \textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespacelibcamera}{libcamera}}\ \{}
\DoxyCodeLine{00026\ }
\DoxyCodeLine{00027\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classlibcamera_1_1DebayerCpu}{DebayerCpu}}\ :\ \textcolor{keyword}{public}\ \mbox{\hyperlink{classlibcamera_1_1Debayer}{Debayer}},\ \textcolor{keyword}{public}\ \mbox{\hyperlink{classlibcamera_1_1Object}{Object}}}
\DoxyCodeLine{00028\ \{}
\DoxyCodeLine{00029\ \textcolor{keyword}{public}:}
\DoxyCodeLine{00030\ \ \ \ \ \mbox{\hyperlink{classlibcamera_1_1DebayerCpu}{DebayerCpu}}(std::unique\_ptr<SwStatsCpu>\ stats);}
\DoxyCodeLine{00031\ \ \ \ \ \mbox{\hyperlink{classlibcamera_1_1DebayerCpu}{\string~DebayerCpu}}();}
\DoxyCodeLine{00032\ }
\DoxyCodeLine{00033\ \ \ \ \ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classlibcamera_1_1DebayerCpu_acfb003482aacb5f4b2756f9f8b185ad9}{configure}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{structlibcamera_1_1StreamConfiguration}{StreamConfiguration}}\ \&inputCfg,}
\DoxyCodeLine{00034\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ std::vector<std::reference\_wrapper<StreamConfiguration>>\ \&outputCfgs);}
\DoxyCodeLine{00035\ \ \ \ \ \mbox{\hyperlink{classlibcamera_1_1Size}{Size}}\ \mbox{\hyperlink{classlibcamera_1_1DebayerCpu_a1244659d82bd7411deaf58b28895de49}{patternSize}}(\mbox{\hyperlink{classlibcamera_1_1PixelFormat}{PixelFormat}}\ inputFormat);}
\DoxyCodeLine{00036\ \ \ \ \ std::vector<PixelFormat>\ \mbox{\hyperlink{classlibcamera_1_1DebayerCpu_aee613f4b8a7d05cd0ccdb98b65009377}{formats}}(\mbox{\hyperlink{classlibcamera_1_1PixelFormat}{PixelFormat}}\ input);}
\DoxyCodeLine{00037\ \ \ \ \ std::tuple<unsigned\ int,\ unsigned\ int>}
\DoxyCodeLine{00038\ \ \ \ \ \mbox{\hyperlink{classlibcamera_1_1DebayerCpu_af235a1381203658b0b8b37f49696d3dd}{strideAndFrameSize}}(\textcolor{keyword}{const}\ \mbox{\hyperlink{classlibcamera_1_1PixelFormat}{PixelFormat}}\ \&outputFormat,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classlibcamera_1_1Size}{Size}}\ \&size);}
\DoxyCodeLine{00039\ \ \ \ \ \textcolor{keywordtype}{void}\ \mbox{\hyperlink{classlibcamera_1_1DebayerCpu_a0e83a0d14d3dc711ae7622c87ef8a655}{process}}(uint32\_t\ frame,\ \mbox{\hyperlink{classlibcamera_1_1FrameBuffer}{FrameBuffer}}\ *input,\ \mbox{\hyperlink{classlibcamera_1_1FrameBuffer}{FrameBuffer}}\ *output,\ \mbox{\hyperlink{structlibcamera_1_1DebayerParams}{DebayerParams}}\ params);}
\DoxyCodeLine{00040\ \ \ \ \ \mbox{\hyperlink{classlibcamera_1_1SizeRange}{SizeRange}}\ \mbox{\hyperlink{classlibcamera_1_1DebayerCpu_a2ed0021813e3ca42fd945b7804f471ca}{sizes}}(\mbox{\hyperlink{classlibcamera_1_1PixelFormat}{PixelFormat}}\ inputFormat,\ \textcolor{keyword}{const}\ \mbox{\hyperlink{classlibcamera_1_1Size}{Size}}\ \&inputSize);}
\DoxyCodeLine{00041\ }
\DoxyCodeLine{00047\ \ \ \ \ \textcolor{keyword}{const}\ \mbox{\hyperlink{classlibcamera_1_1SharedFD}{SharedFD}}\ \&\mbox{\hyperlink{classlibcamera_1_1DebayerCpu_afc389be2603536de8b2b2c400b98bd3a}{getStatsFD}}()\ \{\ \textcolor{keywordflow}{return}\ stats\_-\/>getStatsFD();\ \}}
\DoxyCodeLine{00048\ }
\DoxyCodeLine{00054\ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ \mbox{\hyperlink{classlibcamera_1_1DebayerCpu_a5a2340eb70c69633826a050c8a2fcf61}{frameSize}}()\ \{\ \textcolor{keywordflow}{return}\ outputConfig\_.frameSize;\ \}}
\DoxyCodeLine{00055\ }
\DoxyCodeLine{00056\ \textcolor{keyword}{private}:}
\DoxyCodeLine{00085\ \ \ \ \ \textcolor{keyword}{using\ }debayerFn\ =\ void\ (\mbox{\hyperlink{classlibcamera_1_1DebayerCpu}{DebayerCpu}}::*)(uint8\_t\ *dst,\ const\ uint8\_t\ *src[]);}
\DoxyCodeLine{00086\ }
\DoxyCodeLine{00087\ \ \ \ \ \textcolor{comment}{/*\ 8-\/bit\ raw\ bayer\ format\ */}}
\DoxyCodeLine{00088\ \ \ \ \ \textcolor{keyword}{template}<\textcolor{keywordtype}{bool}\ addAlphaByte>}
\DoxyCodeLine{00089\ \ \ \ \ \textcolor{keywordtype}{void}\ debayer8\_BGBG\_BGR888(uint8\_t\ *dst,\ \textcolor{keyword}{const}\ uint8\_t\ *src[]);}
\DoxyCodeLine{00090\ \ \ \ \ \textcolor{keyword}{template}<\textcolor{keywordtype}{bool}\ addAlphaByte>}
\DoxyCodeLine{00091\ \ \ \ \ \textcolor{keywordtype}{void}\ debayer8\_GRGR\_BGR888(uint8\_t\ *dst,\ \textcolor{keyword}{const}\ uint8\_t\ *src[]);}
\DoxyCodeLine{00092\ \ \ \ \ \textcolor{comment}{/*\ unpacked\ 10-\/bit\ raw\ bayer\ format\ */}}
\DoxyCodeLine{00093\ \ \ \ \ \textcolor{keyword}{template}<\textcolor{keywordtype}{bool}\ addAlphaByte>}
\DoxyCodeLine{00094\ \ \ \ \ \textcolor{keywordtype}{void}\ debayer10\_BGBG\_BGR888(uint8\_t\ *dst,\ \textcolor{keyword}{const}\ uint8\_t\ *src[]);}
\DoxyCodeLine{00095\ \ \ \ \ \textcolor{keyword}{template}<\textcolor{keywordtype}{bool}\ addAlphaByte>}
\DoxyCodeLine{00096\ \ \ \ \ \textcolor{keywordtype}{void}\ debayer10\_GRGR\_BGR888(uint8\_t\ *dst,\ \textcolor{keyword}{const}\ uint8\_t\ *src[]);}
\DoxyCodeLine{00097\ \ \ \ \ \textcolor{comment}{/*\ unpacked\ 12-\/bit\ raw\ bayer\ format\ */}}
\DoxyCodeLine{00098\ \ \ \ \ \textcolor{keyword}{template}<\textcolor{keywordtype}{bool}\ addAlphaByte>}
\DoxyCodeLine{00099\ \ \ \ \ \textcolor{keywordtype}{void}\ debayer12\_BGBG\_BGR888(uint8\_t\ *dst,\ \textcolor{keyword}{const}\ uint8\_t\ *src[]);}
\DoxyCodeLine{00100\ \ \ \ \ \textcolor{keyword}{template}<\textcolor{keywordtype}{bool}\ addAlphaByte>}
\DoxyCodeLine{00101\ \ \ \ \ \textcolor{keywordtype}{void}\ debayer12\_GRGR\_BGR888(uint8\_t\ *dst,\ \textcolor{keyword}{const}\ uint8\_t\ *src[]);}
\DoxyCodeLine{00102\ \ \ \ \ \textcolor{comment}{/*\ CSI-\/2\ packed\ 10-\/bit\ raw\ bayer\ format\ (all\ the\ 4\ orders)\ */}}
\DoxyCodeLine{00103\ \ \ \ \ \textcolor{keyword}{template}<\textcolor{keywordtype}{bool}\ addAlphaByte>}
\DoxyCodeLine{00104\ \ \ \ \ \textcolor{keywordtype}{void}\ debayer10P\_BGBG\_BGR888(uint8\_t\ *dst,\ \textcolor{keyword}{const}\ uint8\_t\ *src[]);}
\DoxyCodeLine{00105\ \ \ \ \ \textcolor{keyword}{template}<\textcolor{keywordtype}{bool}\ addAlphaByte>}
\DoxyCodeLine{00106\ \ \ \ \ \textcolor{keywordtype}{void}\ debayer10P\_GRGR\_BGR888(uint8\_t\ *dst,\ \textcolor{keyword}{const}\ uint8\_t\ *src[]);}
\DoxyCodeLine{00107\ \ \ \ \ \textcolor{keyword}{template}<\textcolor{keywordtype}{bool}\ addAlphaByte>}
\DoxyCodeLine{00108\ \ \ \ \ \textcolor{keywordtype}{void}\ debayer10P\_GBGB\_BGR888(uint8\_t\ *dst,\ \textcolor{keyword}{const}\ uint8\_t\ *src[]);}
\DoxyCodeLine{00109\ \ \ \ \ \textcolor{keyword}{template}<\textcolor{keywordtype}{bool}\ addAlphaByte>}
\DoxyCodeLine{00110\ \ \ \ \ \textcolor{keywordtype}{void}\ debayer10P\_RGRG\_BGR888(uint8\_t\ *dst,\ \textcolor{keyword}{const}\ uint8\_t\ *src[]);}
\DoxyCodeLine{00111\ }
\DoxyCodeLine{00112\ \ \ \ \ \textcolor{keyword}{struct\ }DebayerInputConfig\ \{}
\DoxyCodeLine{00113\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{classlibcamera_1_1Size}{Size}}\ patternSize;}
\DoxyCodeLine{00114\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ bpp;\ \textcolor{comment}{/*\ Memory\ used\ per\ pixel,\ not\ precision\ */}}
\DoxyCodeLine{00115\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ stride;}
\DoxyCodeLine{00116\ \ \ \ \ \ \ \ \ std::vector<PixelFormat>\ outputFormats;}
\DoxyCodeLine{00117\ \ \ \ \ \};}
\DoxyCodeLine{00118\ }
\DoxyCodeLine{00119\ \ \ \ \ \textcolor{keyword}{struct\ }DebayerOutputConfig\ \{}
\DoxyCodeLine{00120\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ bpp;\ \textcolor{comment}{/*\ Memory\ used\ per\ pixel,\ not\ precision\ */}}
\DoxyCodeLine{00121\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ stride;}
\DoxyCodeLine{00122\ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ frameSize;}
\DoxyCodeLine{00123\ \ \ \ \ \};}
\DoxyCodeLine{00124\ }
\DoxyCodeLine{00125\ \ \ \ \ \textcolor{keywordtype}{int}\ getInputConfig(PixelFormat\ inputFormat,\ DebayerInputConfig\ \&config);}
\DoxyCodeLine{00126\ \ \ \ \ \textcolor{keywordtype}{int}\ getOutputConfig(PixelFormat\ outputFormat,\ DebayerOutputConfig\ \&config);}
\DoxyCodeLine{00127\ \ \ \ \ \textcolor{keywordtype}{int}\ setupStandardBayerOrder(\mbox{\hyperlink{classlibcamera_1_1BayerFormat_a72f709c68ce975ab0cbfc65cc5a73b95}{BayerFormat::Order}}\ order);}
\DoxyCodeLine{00128\ \ \ \ \ \textcolor{keywordtype}{int}\ setDebayerFunctions(PixelFormat\ inputFormat,\ PixelFormat\ outputFormat);}
\DoxyCodeLine{00129\ \ \ \ \ \textcolor{keywordtype}{void}\ setupInputMemcpy(\textcolor{keyword}{const}\ uint8\_t\ *linePointers[]);}
\DoxyCodeLine{00130\ \ \ \ \ \textcolor{keywordtype}{void}\ shiftLinePointers(\textcolor{keyword}{const}\ uint8\_t\ *linePointers[],\ \textcolor{keyword}{const}\ uint8\_t\ *src);}
\DoxyCodeLine{00131\ \ \ \ \ \textcolor{keywordtype}{void}\ memcpyNextLine(\textcolor{keyword}{const}\ uint8\_t\ *linePointers[]);}
\DoxyCodeLine{00132\ \ \ \ \ \textcolor{keywordtype}{void}\ process2(\textcolor{keyword}{const}\ uint8\_t\ *src,\ uint8\_t\ *dst);}
\DoxyCodeLine{00133\ \ \ \ \ \textcolor{keywordtype}{void}\ process4(\textcolor{keyword}{const}\ uint8\_t\ *src,\ uint8\_t\ *dst);}
\DoxyCodeLine{00134\ }
\DoxyCodeLine{00135\ \ \ \ \ \textcolor{comment}{/*\ Max.\ supported\ Bayer\ pattern\ height\ is\ 4,\ debayering\ this\ requires\ 5\ lines\ */}}
\DoxyCodeLine{00136\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{constexpr}\ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ kMaxLineBuffers\ =\ 5;}
\DoxyCodeLine{00137\ }
\DoxyCodeLine{00138\ \ \ \ \ \mbox{\hyperlink{structlibcamera_1_1DebayerParams_a4dc4a70a5957cbd4410b37063e74f4ef}{DebayerParams::ColorLookupTable}}\ red\_;}
\DoxyCodeLine{00139\ \ \ \ \ \mbox{\hyperlink{structlibcamera_1_1DebayerParams_a4dc4a70a5957cbd4410b37063e74f4ef}{DebayerParams::ColorLookupTable}}\ green\_;}
\DoxyCodeLine{00140\ \ \ \ \ \mbox{\hyperlink{structlibcamera_1_1DebayerParams_a4dc4a70a5957cbd4410b37063e74f4ef}{DebayerParams::ColorLookupTable}}\ blue\_;}
\DoxyCodeLine{00141\ \ \ \ \ debayerFn\ debayer0\_;}
\DoxyCodeLine{00142\ \ \ \ \ debayerFn\ debayer1\_;}
\DoxyCodeLine{00143\ \ \ \ \ debayerFn\ debayer2\_;}
\DoxyCodeLine{00144\ \ \ \ \ debayerFn\ debayer3\_;}
\DoxyCodeLine{00145\ \ \ \ \ Rectangle\ window\_;}
\DoxyCodeLine{00146\ \ \ \ \ DebayerInputConfig\ inputConfig\_;}
\DoxyCodeLine{00147\ \ \ \ \ DebayerOutputConfig\ outputConfig\_;}
\DoxyCodeLine{00148\ \ \ \ \ std::unique\_ptr<SwStatsCpu>\ stats\_;}
\DoxyCodeLine{00149\ \ \ \ \ std::vector<uint8\_t>\ lineBuffers\_[kMaxLineBuffers];}
\DoxyCodeLine{00150\ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ lineBufferLength\_;}
\DoxyCodeLine{00151\ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ lineBufferPadding\_;}
\DoxyCodeLine{00152\ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ lineBufferIndex\_;}
\DoxyCodeLine{00153\ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ xShift\_;\ \textcolor{comment}{/*\ Offset\ of\ 0/1\ applied\ to\ window\_.x\ */}}
\DoxyCodeLine{00154\ \ \ \ \ \textcolor{keywordtype}{bool}\ enableInputMemcpy\_;}
\DoxyCodeLine{00155\ \ \ \ \ \textcolor{keywordtype}{bool}\ swapRedBlueGains\_;}
\DoxyCodeLine{00156\ \ \ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ measuredFrames\_;}
\DoxyCodeLine{00157\ \ \ \ \ int64\_t\ frameProcessTime\_;}
\DoxyCodeLine{00158\ \ \ \ \ \textcolor{comment}{/*\ Skip\ 30\ frames\ for\ things\ to\ stabilize\ then\ measure\ 30\ frames\ */}}
\DoxyCodeLine{00159\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{constexpr}\ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ kFramesToSkip\ =\ 30;}
\DoxyCodeLine{00160\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{constexpr}\ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ kLastFrameToMeasure\ =\ 60;}
\DoxyCodeLine{00161\ \};}
\DoxyCodeLine{00162\ }
\DoxyCodeLine{00163\ \}\ \textcolor{comment}{/*\ namespace\ libcamera\ */}}

\end{DoxyCode}

\doxysection{libcamera\+::ipa\+::FCQueue\texorpdfstring{$<$}{<} Frame\+Context \texorpdfstring{$>$}{>} Class Template Reference}
\hypertarget{classlibcamera_1_1ipa_1_1FCQueue}{}\label{classlibcamera_1_1ipa_1_1FCQueue}\index{libcamera::ipa::FCQueue$<$ FrameContext $>$@{libcamera::ipa::FCQueue$<$ FrameContext $>$}}


A support class for managing \doxylink{structlibcamera_1_1ipa_1_1FrameContext}{Frame\+Context} instances in IPA modules.  


\doxysubsubsection*{Public Member Functions}
\begin{DoxyCompactItemize}
\item 
\mbox{\hyperlink{classlibcamera_1_1ipa_1_1FCQueue_a04b07447b9ff942b5bdb35f22110876f}{FCQueue}} (unsigned int size)
\begin{DoxyCompactList}\small\item\em Construct a frame contexts queue of a specified size. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{classlibcamera_1_1ipa_1_1FCQueue_a7a76eebb86d4d5b41fff9d4e950fb385}{clear}} ()
\begin{DoxyCompactList}\small\item\em Clear the contexts queue. \end{DoxyCompactList}\item 
\mbox{\hyperlink{structlibcamera_1_1ipa_1_1FrameContext}{Frame\+Context}} \& \mbox{\hyperlink{classlibcamera_1_1ipa_1_1FCQueue_a30a8f9b03de53964effa77b76aeef6e5}{alloc}} (const uint32\+\_\+t frame)
\begin{DoxyCompactList}\small\item\em Allocate and return a \doxylink{structlibcamera_1_1ipa_1_1FrameContext}{Frame\+Context} for the {\itshape frame}. \end{DoxyCompactList}\item 
\mbox{\hyperlink{structlibcamera_1_1ipa_1_1FrameContext}{Frame\+Context}} \& \mbox{\hyperlink{classlibcamera_1_1ipa_1_1FCQueue_a280f05d67bf0803ac96b777b41c11040}{get}} (uint32\+\_\+t frame)
\begin{DoxyCompactList}\small\item\em Obtain the \doxylink{structlibcamera_1_1ipa_1_1FrameContext}{Frame\+Context} for the {\itshape frame}. \end{DoxyCompactList}\end{DoxyCompactItemize}


\doxysubsection{Detailed Description}
\subsubsection*{template$<$typename \mbox{\hyperlink{structlibcamera_1_1ipa_1_1FrameContext}{Frame\+Context}}$>$\newline
class libcamera\+::ipa\+::\+FCQueue$<$ Frame\+Context $>$}
A support class for managing \doxylink{structlibcamera_1_1ipa_1_1FrameContext}{Frame\+Context} instances in IPA modules. 


\begin{DoxyTemplParams}{Template Parameters}
{\em \doxylink{structlibcamera_1_1ipa_1_1FrameContext}{Frame\+Context}} & The IPA module-\/specific \doxylink{structlibcamera_1_1ipa_1_1FrameContext}{Frame\+Context} derived class type\\
\hline
\end{DoxyTemplParams}
Along with the \doxylink{classlibcamera_1_1ipa_1_1Module}{Module} and \doxylink{classlibcamera_1_1ipa_1_1Algorithm}{Algorithm} classes, the frame context queue is a core component of the libipa infrastructure. It stores per-\/frame contexts used by the \doxylink{classlibcamera_1_1ipa_1_1Algorithm}{Algorithm} operations. By centralizing the lifetime management of the contexts and implementing safeguards against underflows and overflows, it simplifies IPA modules and improves their reliability.

The queue references frame contexts by a monotonically increasing sequence number. The \doxylink{classlibcamera_1_1ipa_1_1FCQueue}{FCQueue} design assumes that this number matches both the sequence number of the corresponding frame, as generated by the camera sensor, and the sequence number of the request. This allows IPA modules to obtain the frame context from any location where a request or a frame is available.

A frame context normally begins its lifetime when the corresponding request is queued, way before the frame is captured by the camera sensor. IPA modules allocate the context from the queue at that point, calling \doxylink{classlibcamera_1_1ipa_1_1FCQueue_a30a8f9b03de53964effa77b76aeef6e5}{alloc()} using the request number. The queue initializes the context, and the IPA module then populates it with data from the request. The context can be later retrieved with a call to \doxylink{classlibcamera_1_1ipa_1_1FCQueue_a280f05d67bf0803ac96b777b41c11040}{get()}, typically when the IPA module is requested to provide sensor or ISP parameters or receives statistics for a frame. The frame number is used at that point to identify the context.

If an application fails to queue requests to the camera fast enough, frames may be produced by the camera sensor and processed by the IPA module without a corresponding request having been queued to the IPA module. This creates an underrun condition, where the IPA module will try to get a frame context that hasn\textquotesingle{}t been allocated. In this case, the \doxylink{classlibcamera_1_1ipa_1_1FCQueue_a280f05d67bf0803ac96b777b41c11040}{get()} function will allocate and initialize a context for the frame, and log a message. Algorithms will not apply the controls associated with the late request, but should otherwise behave correctly.

\begin{DoxyRefDesc}{Todo}
\item[\mbox{\hyperlink{todo__todo000008}{Todo}}]Mark the frame context with a per-\/frame control error flag in case of underrun, and research how algorithms should handle this.\end{DoxyRefDesc}


At its core, the queue uses a circular buffer to avoid dynamic memory allocation at runtime. The buffer is pre-\/allocated with a maximum number of entries when the \doxylink{classlibcamera_1_1ipa_1_1FCQueue}{FCQueue} instance is constructed. Entries are initialized on first use by \doxylink{classlibcamera_1_1ipa_1_1FCQueue_a30a8f9b03de53964effa77b76aeef6e5}{alloc()} or, in underrun conditions, \doxylink{classlibcamera_1_1ipa_1_1FCQueue_a280f05d67bf0803ac96b777b41c11040}{get()}. The queue is not allowed to overflow, which must be ensured by pipeline handlers never queuing more in-\/flight requests to the IPA module than the queue size. If an overflow condition is detected, the queue will log a fatal error.

IPA module-\/specific frame context implementations shall inherit from the \doxylink{structlibcamera_1_1ipa_1_1FrameContext}{Frame\+Context} base class to support the minimum required features for a \doxylink{structlibcamera_1_1ipa_1_1FrameContext}{Frame\+Context}. 

\doxysubsection{Constructor \& Destructor Documentation}
\Hypertarget{classlibcamera_1_1ipa_1_1FCQueue_a04b07447b9ff942b5bdb35f22110876f}\label{classlibcamera_1_1ipa_1_1FCQueue_a04b07447b9ff942b5bdb35f22110876f} 
\index{libcamera::ipa::FCQueue$<$ FrameContext $>$@{libcamera::ipa::FCQueue$<$ FrameContext $>$}!FCQueue@{FCQueue}}
\index{FCQueue@{FCQueue}!libcamera::ipa::FCQueue$<$ FrameContext $>$@{libcamera::ipa::FCQueue$<$ FrameContext $>$}}
\doxysubsubsection{\texorpdfstring{FCQueue()}{FCQueue()}}
{\footnotesize\ttfamily template$<$typename \mbox{\hyperlink{structlibcamera_1_1ipa_1_1FrameContext}{Frame\+Context}} $>$ \\
\mbox{\hyperlink{classlibcamera_1_1ipa_1_1FCQueue}{libcamera\+::ipa\+::\+FCQueue}}$<$ \mbox{\hyperlink{structlibcamera_1_1ipa_1_1FrameContext}{Frame\+Context}} $>$\+::\+FCQueue (\begin{DoxyParamCaption}\item[{unsigned int}]{size }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [inline]}}



Construct a frame contexts queue of a specified size. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em size} & The number of contexts in the queue \\
\hline
\end{DoxyParams}


\doxysubsection{Member Function Documentation}
\Hypertarget{classlibcamera_1_1ipa_1_1FCQueue_a30a8f9b03de53964effa77b76aeef6e5}\label{classlibcamera_1_1ipa_1_1FCQueue_a30a8f9b03de53964effa77b76aeef6e5} 
\index{libcamera::ipa::FCQueue$<$ FrameContext $>$@{libcamera::ipa::FCQueue$<$ FrameContext $>$}!alloc@{alloc}}
\index{alloc@{alloc}!libcamera::ipa::FCQueue$<$ FrameContext $>$@{libcamera::ipa::FCQueue$<$ FrameContext $>$}}
\doxysubsubsection{\texorpdfstring{alloc()}{alloc()}}
{\footnotesize\ttfamily template$<$typename \mbox{\hyperlink{structlibcamera_1_1ipa_1_1FrameContext}{Frame\+Context}} $>$ \\
\mbox{\hyperlink{classlibcamera_1_1ipa_1_1FCQueue}{libcamera\+::ipa\+::\+FCQueue}}$<$ \mbox{\hyperlink{structlibcamera_1_1ipa_1_1FrameContext}{Frame\+Context}} $>$\+::alloc (\begin{DoxyParamCaption}\item[{const uint32\+\_\+t}]{frame }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [inline]}}



Allocate and return a \doxylink{structlibcamera_1_1ipa_1_1FrameContext}{Frame\+Context} for the {\itshape frame}. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em frame} & The frame context sequence number\\
\hline
\end{DoxyParams}
The first call to obtain a \doxylink{structlibcamera_1_1ipa_1_1FrameContext}{Frame\+Context} from the \doxylink{classlibcamera_1_1ipa_1_1FCQueue}{FCQueue} should be handled through this function. The \doxylink{structlibcamera_1_1ipa_1_1FrameContext}{Frame\+Context} will be initialised, if not initialised already, and returned to the caller.

If the \doxylink{structlibcamera_1_1ipa_1_1FrameContext}{Frame\+Context} was already initialized for this {\itshape frame}, a warning will be reported and the previously initialized \doxylink{structlibcamera_1_1ipa_1_1FrameContext}{Frame\+Context} is returned.

Frame contexts are expected to be initialised when a \doxylink{classlibcamera_1_1Request}{Request} is first passed to the IPA module in IPAModule\+::queue\+Request().

\begin{DoxyReturn}{Returns}
A reference to the \doxylink{structlibcamera_1_1ipa_1_1FrameContext}{Frame\+Context} for sequence {\itshape frame} 
\end{DoxyReturn}
\Hypertarget{classlibcamera_1_1ipa_1_1FCQueue_a7a76eebb86d4d5b41fff9d4e950fb385}\label{classlibcamera_1_1ipa_1_1FCQueue_a7a76eebb86d4d5b41fff9d4e950fb385} 
\index{libcamera::ipa::FCQueue$<$ FrameContext $>$@{libcamera::ipa::FCQueue$<$ FrameContext $>$}!clear@{clear}}
\index{clear@{clear}!libcamera::ipa::FCQueue$<$ FrameContext $>$@{libcamera::ipa::FCQueue$<$ FrameContext $>$}}
\doxysubsubsection{\texorpdfstring{clear()}{clear()}}
{\footnotesize\ttfamily template$<$typename \mbox{\hyperlink{structlibcamera_1_1ipa_1_1FrameContext}{Frame\+Context}} $>$ \\
\mbox{\hyperlink{classlibcamera_1_1ipa_1_1FCQueue}{libcamera\+::ipa\+::\+FCQueue}}$<$ \mbox{\hyperlink{structlibcamera_1_1ipa_1_1FrameContext}{Frame\+Context}} $>$\+::clear (\begin{DoxyParamCaption}{ }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [inline]}}



Clear the contexts queue. 

IPA modules must clear the frame context queue at the beginning of a new streaming session, in IPAModule\+::start().

\begin{DoxyRefDesc}{Todo}
\item[\mbox{\hyperlink{todo__todo000009}{Todo}}]Fix any issue this may cause with requests queued before the camera is started. \end{DoxyRefDesc}
\Hypertarget{classlibcamera_1_1ipa_1_1FCQueue_a280f05d67bf0803ac96b777b41c11040}\label{classlibcamera_1_1ipa_1_1FCQueue_a280f05d67bf0803ac96b777b41c11040} 
\index{libcamera::ipa::FCQueue$<$ FrameContext $>$@{libcamera::ipa::FCQueue$<$ FrameContext $>$}!get@{get}}
\index{get@{get}!libcamera::ipa::FCQueue$<$ FrameContext $>$@{libcamera::ipa::FCQueue$<$ FrameContext $>$}}
\doxysubsubsection{\texorpdfstring{get()}{get()}}
{\footnotesize\ttfamily template$<$typename \mbox{\hyperlink{structlibcamera_1_1ipa_1_1FrameContext}{Frame\+Context}} $>$ \\
\mbox{\hyperlink{classlibcamera_1_1ipa_1_1FCQueue}{libcamera\+::ipa\+::\+FCQueue}}$<$ \mbox{\hyperlink{structlibcamera_1_1ipa_1_1FrameContext}{Frame\+Context}} $>$\+::get (\begin{DoxyParamCaption}\item[{uint32\+\_\+t}]{frame }\end{DoxyParamCaption})\hspace{0.3cm}{\ttfamily [inline]}}



Obtain the \doxylink{structlibcamera_1_1ipa_1_1FrameContext}{Frame\+Context} for the {\itshape frame}. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em frame} & The frame context sequence number\\
\hline
\end{DoxyParams}
If the \doxylink{structlibcamera_1_1ipa_1_1FrameContext}{Frame\+Context} is not correctly initialised for the {\itshape frame}, it will be initialised.

\begin{DoxyReturn}{Returns}
A reference to the \doxylink{structlibcamera_1_1ipa_1_1FrameContext}{Frame\+Context} for sequence {\itshape frame} 
\end{DoxyReturn}


The documentation for this class was generated from the following files\+:\begin{DoxyCompactItemize}
\item 
src/peripherals/camera/libcamera/src/ipa/libipa/\mbox{\hyperlink{fc__queue_8h}{fc\+\_\+queue.\+h}}\item 
src/peripherals/camera/libcamera/src/ipa/libipa/fc\+\_\+queue.\+cpp\end{DoxyCompactItemize}
